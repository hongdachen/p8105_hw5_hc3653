---
title: "p8105_hw5_hc3653"
author: "Hongda Chen"
date: "2025-11-14"
output: github_document
---
```{r}
library(tidyverse)
set.seed(1)
```

# Problem 1
```{r}
birth_sim = function(n_room) { 
  birthdays = sample(1:365, n_room, replace = TRUE)
  repeated_birth = length(unique(birthdays)) < n_room
  repeated_birth}

birth_sim(30)
```

```{r}
birth_sim_results = 
  expand_grid(
    birth = 2:50,
    iter = 1:10000
  ) |>
  mutate(
    result = map_lgl(birth, birth_sim)
  ) |>
  group_by(birth) |>
  summarise(
    prob = mean(result)
  )
```

```{r}
birth_sim_results |>
  ggplot(aes(x = birth, y = prob)) +
  geom_point() +
  geom_line() +
  labs(
    x = "Birthdays",
    y = "Probability of repeats",
    title = "Birthday simulation"
  )
```

From the graph, we can see that the overall trend is increasing gradually. When 
the number of people is extremely small, the probability of same birthday is 
almost 0. When the number of people approaches 50, the probability approaches 1.
The mid-point of probability happens when the number of people is exactly 23.

# Problem 2
```{r}
sim = function(mu) {
  x = rnorm(30, mean = mu, sd = 5)
  output = t.test(x, mu = 0)
  broom::tidy(output)
}
```

```{r}
sim_results = function(mu) {
  results = tibble(
    estimate = numeric(5000),
    P_value = numeric(5000)
  )
  for (i in 1:5000) {
    output = sim(mu)
    results$estimate[i] = output$estimate
    results$p_value[i] = output$p.value
  }
  results <- results %>% mutate(mu_true = mu)
}
```

```{r warning=FALSE, message=FALSE}
all_mu_results = tibble()

for (i in 0:6) {
  single_result = sim_results(i)
  all_mu_results = bind_rows(all_mu_results, single_result)
  }
  
```

```{r}
power = all_mu_results %>% 
  group_by(mu_true) %>% 
  summarize(power = mean(p_value < 0.05))
ggplot(power, aes(x = mu_true, y = power)) +
  geom_point() +
  geom_line() +
  labs(x = "True value of mu",
       y = "Power of the test",
       title = "Power of the test")
```

The effect size and power is positively related, larger the mu, more likely to 
reject the null hypothesis, so larger the power. 

```{r}
aveg_estimate_df = 
  all_mu_results %>%
  group_by(mu_true) %>%
  summarize(aveg_estimate = mean(estimate))
ggplot(aveg_estimate_df,
       aes(x = mu_true, y = aveg_estimate)) +
  geom_point() +
  geom_line() +
  labs(x = "True value of mu",
       y = "Average estimate of mu",
       title = "Average estimate vs true value of mu")
```

```{r}
aveg_estimate_rej_df = 
  all_mu_results %>%
  filter(p_value < 0.05) %>%
  group_by(mu_true) %>%
  summarize(aveg_estimate = mean(estimate))
ggplot(aveg_estimate_rej_df,
       aes(x = mu_true, y = aveg_estimate )) +
  geom_point() +
  geom_line() +
  labs(x = "True value of mu",
       y = "Average estimate of mu",
       title = "Average estimate vs true value of mu when reject the null")
```

In samples for which the null hypothesis was rejected, the average estimate of
mu is greater than true value of mu, particularly when mu is small, because of
the selection bias.

# Problem 3
```{r}
homicide = read.csv("/Users/hongdachen/Desktop/homicide-data.csv")
```

```{r}
summary(homicide)
```
The raw data describes 52179 criminal homicides in 50 of the largest
cities in the states between 2007 and 2015. The data contains some key 
variables such as name, age, location and disposition.

```{r}
homicide = homicide %>%
  mutate(city_state = paste(city, state, sep = ","))
```

```{r}
summary_disposition = homicide %>%
  group_by(city_state) %>%
  summarise(
    total_homicide = n(),
    unsolved_homicide = sum(disposition %in% c("Closed without arrest", "Open/No arrest")),
    .groups = "drop"
  )
```

```{r}
baltimore = summary_disposition %>% filter(city_state == "Baltimore,MD")

test_baltimore = prop.test(
  x = baltimore$unsolved_homicide,
  n = baltimore$total_homicide
)

tidy_baltimore = broom::tidy(test_baltimore)

baltimore_prop_CI = tidy_baltimore %>% 
  select(estimate, conf.low, conf.high)

print(baltimore_prop_CI)
```

```{r warning=FALSE, message=FALSE}
test_all_cities = summary_disposition %>%
  mutate(
    results = map2(unsolved_homicide, total_homicide, ~prop.test(.x,.y) %>% 
                     broom::tidy())
  ) %>%
  unnest(results) %>%
  select(city_state, estimate, conf.low, conf.high)

print(test_all_cities)
```

```{r}
ggplot(test_all_cities, 
       aes(x = fct_reorder(city_state, estimate), y = estimate, color = city_state)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high)) +
  labs(
    x = "City",
    y = "Estimated proportion of unsolved homicides",
    title = "Proportion of unsolved homicides"
  ) +
  theme(axis.text.x = element_text(size = 6 , angle = 60, hjust = 1)) +
  theme(legend.position = "none")
```

